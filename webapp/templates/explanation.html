{% extends "base.html" %}

{% block title %}Explanation - {{ crop_name }} | CropAI{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="text-center mb-5">
        <h2 class="fw-bold">
            <i class="bi bi-lightbulb text-warning me-2"></i>Why {{ crop_name }}?
        </h2>
        <p class="text-muted">Understanding the AI's recommendation in simple terms</p>
        {% if shap_available %}
        <span class="badge bg-success">SHAP Analysis (Explainable AI)</span>
        {% else %}
        <span class="badge bg-secondary">Feature Analysis</span>
        {% endif %}
    </div>

    <!-- Your Input Values (compact summary) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-sliders me-2"></i>Your Soil & Climate Inputs
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6 col-md-3 col-lg">
                            <div class="text-center p-2 bg-light rounded">
                                <i class="bi bi-radioactive text-success fs-4"></i>
                                <small class="text-muted d-block">Nitrogen</small>
                                <strong>{{ inputs.N }} kg/ha</strong>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 col-lg">
                            <div class="text-center p-2 bg-light rounded">
                                <i class="bi bi-flower2 text-warning fs-4"></i>
                                <small class="text-muted d-block">Phosphorus</small>
                                <strong>{{ inputs.P }} kg/ha</strong>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 col-lg">
                            <div class="text-center p-2 bg-light rounded">
                                <i class="bi bi-gem text-info fs-4"></i>
                                <small class="text-muted d-block">Potassium</small>
                                <strong>{{ inputs.K }} kg/ha</strong>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 col-lg">
                            <div class="text-center p-2 bg-light rounded">
                                <i class="bi bi-thermometer-sun text-danger fs-4"></i>
                                <small class="text-muted d-block">Temperature</small>
                                <strong>{{ inputs.temperature }}°C</strong>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 col-lg">
                            <div class="text-center p-2 bg-light rounded">
                                <i class="bi bi-droplet-half text-primary fs-4"></i>
                                <small class="text-muted d-block">Humidity</small>
                                <strong>{{ inputs.humidity }}%</strong>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 col-lg">
                            <div class="text-center p-2 bg-light rounded">
                                <i class="bi bi-moisture text-secondary fs-4"></i>
                                <small class="text-muted d-block">Soil pH</small>
                                <strong>{{ inputs.ph }}</strong>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 col-lg">
                            <div class="text-center p-2 bg-light rounded">
                                <i class="bi bi-cloud-rain text-primary fs-4"></i>
                                <small class="text-muted d-block">Rainfall</small>
                                <strong>{{ inputs.rainfall }} mm</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Farmer-Friendly Explanation (full width) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-quote me-2"></i>Detailed Explanation for Farmers
                    </h5>
                </div>
                <div class="card-body">
                    <div class="explanation-text">
                        {{ explanation_text|safe }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feature Contributions (technical chart + progress bars) -->
    <div class="row g-4">
        <!-- Feature Contribution Bars -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-bar-chart me-2"></i>Feature Contributions
                    </h5>
                </div>
                <div class="card-body">
                    {% if explanation and explanation.top_features %}
                    <p class="text-muted small mb-4">
                        How much each factor pushed the AI towards or away from {{ crop_name }}:
                    </p>

                    {% set ns = namespace(max_abs=0.001) %}
                    {% for feat in explanation.top_features %}
                        {% if feat.shap_value|abs > ns.max_abs %}
                            {% set ns.max_abs = feat.shap_value|abs %}
                        {% endif %}
                    {% endfor %}

                    {% for feat in explanation.top_features %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="fw-medium">{{ feat.feature }}</span>
                            <span class="{% if feat.shap_value > 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ feat.contribution }}
                            </span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            {% set width = ((feat.shap_value|abs / ns.max_abs) * 100)|int %}
                            {% if width < 5 %}{% set width = 5 %}{% endif %}
                            <div class="progress-bar {% if feat.shap_value > 0 %}bg-success{% else %}bg-danger{% endif %}"
                                style="width: {{ width }}%">
                                {% if feat.shap_value > 0 %}+{% endif %}{{ "%.3f"|format(feat.shap_value) }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <div class="alert alert-info mt-4 small">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>How to read:</strong> Green bars mean that factor helps recommend {{ crop_name }}.
                        Red bars mean that factor slightly goes against it. Longer bars mean stronger effect.
                    </div>
                    {% else %}
                    <p class="text-muted">Feature contribution data not available.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Feature Impact Chart -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="fw-bold mb-4">
                        <i class="bi bi-bar-chart-steps me-2"></i>Feature Impact Chart
                    </h5>
                    <canvas id="featureChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- SHAP Visualization -->
    {% if plots and plots.waterfall %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>SHAP Waterfall Plot
                    </h5>
                </div>
                <div class="card-body text-center">
                    <img src="{{ url_for('static', filename=plots.waterfall) }}" alt="SHAP Waterfall Plot"
                        class="img-fluid rounded shadow">
                    <p class="text-muted mt-3 small">
                        This chart is generated by SHAP (SHapley Additive exPlanations), a method from game theory
                        that fairly distributes the "credit" for the prediction among all input features.
                        Green bars push the prediction towards {{ crop_name }}, red bars push away from it.
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="text-center mt-5">
        <a href="{{ url_for('economic', crop_name=crop_name) }}" class="btn btn-success btn-lg me-2">
            <i class="bi bi-currency-rupee me-2"></i>Economic Analysis
        </a>
        <a href="{{ url_for('rotation', crop_name=crop_name) }}" class="btn btn-primary btn-lg me-2">
            <i class="bi bi-arrow-repeat me-2"></i>Rotation Plan
        </a>
        <a href="{{ url_for('predict') }}" class="btn btn-outline-secondary btn-lg">
            <i class="bi bi-arrow-counterclockwise me-2"></i>New Prediction
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Pass data as JSON -->
<script type="application/json" id="explanationData">
{{ explanation.top_features | tojson | safe if explanation and explanation.top_features else '[]' }}
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        try {
            var featureData = JSON.parse(document.getElementById('explanationData').textContent);

            if (featureData && featureData.length > 0) {
                var labels = featureData.map(function (d) { return d.feature; });
                var values = featureData.map(function (d) { return d.shap_value; });
                var bgColors = values.map(function (v) { return v > 0 ? 'rgba(40, 167, 69, 0.7)' : 'rgba(220, 53, 69, 0.7)'; });
                var borderColors = values.map(function (v) { return v > 0 ? 'rgb(40, 167, 69)' : 'rgb(220, 53, 69)'; });

                var ctx = document.getElementById('featureChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Contribution',
                            data: values,
                            backgroundColor: bgColors,
                            borderColor: borderColors,
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: 'Feature Contributions to Prediction'
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0,0,0,0.05)' }
                            }
                        }
                    }
                });
                console.log('✅ Feature chart created!');
            }
        } catch (error) {
            console.error('Chart error:', error);
        }
    });
</script>
{% endblock %}