{% extends "base.html" %}

{% block title %}Results - CropAI{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="text-center mb-5">
        <h2 class="fw-bold">
            <i class="bi bi-check-circle text-success me-2"></i>Crop Recommendations
        </h2>
        <p class="text-muted">Based on your soil and climate parameters</p>
        <small class="text-muted">Generated: {{ timestamp }}</small>
    </div>

    <!-- Input Summary -->
    <div class="card mb-4">
        <div class="card-body">
            <h6 class="fw-bold mb-3"><i class="bi bi-info-circle me-2"></i>Your Input Parameters</h6>
            <div class="row g-2 small">
                <div class="col-auto">
                    <span class="badge bg-light text-dark">N: {{ inputs.N }} kg/ha</span>
                </div>
                <div class="col-auto">
                    <span class="badge bg-light text-dark">P: {{ inputs.P }} kg/ha</span>
                </div>
                <div class="col-auto">
                    <span class="badge bg-light text-dark">K: {{ inputs.K }} kg/ha</span>
                </div>
                <div class="col-auto">
                    <span class="badge bg-light text-dark">Temp: {{ inputs.temperature }}°C</span>
                </div>
                <div class="col-auto">
                    <span class="badge bg-light text-dark">Humidity: {{ inputs.humidity }}%</span>
                </div>
                <div class="col-auto">
                    <span class="badge bg-light text-dark">pH: {{ inputs.ph }}</span>
                </div>
                <div class="col-auto">
                    <span class="badge bg-light text-dark">Rainfall: {{ inputs.rainfall }}mm</span>
                </div>
                <div class="col-auto">
                    <span class="badge bg-success">Season: {{ inputs.season }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Hero: Top Recommendation with Speedometer Gauge -->
    <div class="row mb-5">
        <div class="col-lg-6 mx-auto">
            <div class="card border-success border-3 shadow-lg">
                <div class="card-header bg-success text-white text-center py-3">
                    <h4 class="mb-0"><i class="bi bi-trophy-fill me-2"></i>Best Crop For Your Land</h4>
                </div>
                <div class="card-body text-center py-4">
                    {% set top = predictions[0] %}

                    <!-- Speedometer Gauge -->
                    <div class="position-relative d-inline-block mb-3" style="width: 220px; height: 130px;">
                        <canvas id="suitabilityGauge" width="220" height="130"></canvas>
                        <div class="position-absolute" style="bottom: 10px; left: 50%; transform: translateX(-50%);">
                            <h2 class="mb-0 text-success fw-bold">{{ "%.0f"|format(top.probability * 100) }}%</h2>
                            <small class="text-muted">Suitability</small>
                        </div>
                    </div>

                    <h2 class="fw-bold text-success mb-2">{{ top.crop }}</h2>
                    <span class="badge bg-{{ top.category_class }} px-4 py-2 fs-6 mb-3">{{ top.category }}</span>

                    <!-- Quick Stats -->
                    <div class="row g-3 mt-3">
                        <div class="col-4">
                            <div class="p-2 bg-light rounded">
                                <i class="bi bi-graph-up-arrow text-success fs-4"></i>
                                <div class="fw-bold">{{ "%.0f"|format(top.economic.roi) }}%</div>
                                <small class="text-muted">ROI</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 bg-light rounded">
                                <i class="bi bi-currency-rupee text-primary fs-4"></i>
                                <div class="fw-bold">₹{{ "%.0f"|format(top.economic.profit) }}</div>
                                <small class="text-muted">Profit</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 bg-light rounded">
                                <i class="bi bi-shield-check text-warning fs-4"></i>
                                <div class="fw-bold">{{ top.economic.risk_category }}</div>
                                <small class="text-muted">Risk</small>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <a href="{{ url_for('economic', crop_name=top.crop) }}" class="btn btn-success btn-lg me-2">
                            <i class="bi bi-graph-up me-2"></i>Full Analysis
                        </a>
                        <a href="{{ url_for('explain') }}" class="btn btn-outline-warning">
                            <i class="bi bi-lightbulb me-2"></i>Why This?
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alternative Recommendations -->
    <div class="row g-4 mb-5">
        <div class="col-12">
            <h5 class="fw-bold mb-3"><i class="bi bi-list-stars me-2"></i>Other Good Options</h5>
        </div>
        {% for pred in predictions[1:] %}
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <!-- Mini Gauge -->
                        <div class="position-relative me-3" style="width: 80px; height: 50px;">
                            <canvas id="miniGauge{{ loop.index }}" width="80" height="50"></canvas>
                            <div class="position-absolute" style="bottom: 0; left: 50%; transform: translateX(-50%);">
                                <strong class="small">{{ "%.0f"|format(pred.probability * 100) }}%</strong>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="mb-1">{{ pred.crop }}</h5>
                            <span class="badge bg-{{ pred.category_class }} small">{{ pred.category }}</span>
                        </div>
                        <div class="text-end">
                            <div class="text-success fw-bold">{{ "%.0f"|format(pred.economic.roi) }}% ROI</div>
                            <small class="text-muted">{{ pred.economic.risk_category }} Risk</small>
                        </div>
                    </div>
                    <div class="mt-3 text-end">
                        <a href="{{ url_for('economic', crop_name=pred.crop) }}" class="btn btn-sm btn-outline-success">
                            <i class="bi bi-arrow-right"></i> Details
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Probability Chart -->
    <div class="row mb-5">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-body">
                    <h5 class="fw-bold mb-4">
                        <i class="bi bi-bar-chart me-2"></i>Probability Distribution
                    </h5>
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="probabilityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Recommendation Details -->
    {% set top = predictions[0] %}
    <div class="row g-4">
        <!-- Economic Analysis -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-currency-rupee text-success me-2"></i>Economic Analysis: {{ top.crop }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if top.economic %}
                    <table class="table table-borderless">
                        <tr>
                            <td>Return on Investment (ROI)</td>
                            <td class="fw-bold text-success">{{ "%.1f"|format(top.economic.roi) }}%</td>
                        </tr>
                        <tr>
                            <td>Estimated Profit</td>
                            <td class="fw-bold">₹{{ "%.0f"|format(top.economic.profit) }}/acre</td>
                        </tr>
                        <tr>
                            <td>Profit Margin</td>
                            <td>{{ "%.1f"|format(top.economic.profit_margin) }}%</td>
                        </tr>
                        <tr>
                            <td>Price Volatility</td>
                            <td>{{ "%.1f"|format(top.economic.volatility) }}%</td>
                        </tr>
                        <tr>
                            <td>Risk Category</td>
                            <td>
                                <span class="badge 
                                    {% if top.economic.risk_category == 'Low' %}bg-success
                                    {% elif top.economic.risk_category == 'Medium' %}bg-warning
                                    {% else %}bg-danger{% endif %}">
                                    {{ top.economic.risk_category }}
                                </span>
                            </td>
                        </tr>
                    </table>
                    {% else %}
                    <p class="text-muted">Economic data not available for this crop.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Rotation Plan -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-arrow-repeat text-success me-2"></i>Rotation Plan
                    </h5>
                </div>
                <div class="card-body">
                    {% if top.rotation %}
                    <div class="timeline">
                        {% for item in top.rotation.plan %}
                        <div class="d-flex align-items-center mb-3">
                            <div class="rounded-circle 
                                {% if loop.index == 1 %}bg-success{% else %}bg-secondary{% endif %} 
                                text-white d-flex align-items-center justify-content-center me-3"
                                style="width: 40px; height: 40px; min-width: 40px;">
                                {{ loop.index }}
                            </div>
                            <div>
                                <strong>{{ item.season }}</strong>
                                <span class="d-block text-muted">{{ item.crop }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3 pt-3 border-top">
                        <div class="row text-center">
                            <div class="col-6">
                                <span class="text-muted d-block small">Sustainability Score</span>
                                <strong class="text-success">{{ top.rotation.sustainability_score }}/100</strong>
                            </div>
                            <div class="col-6">
                                <span class="text-muted d-block small">Benefit</span>
                                <strong>{{ top.rotation.benefit }}</strong>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted">Rotation plan not available.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Share Results -->
    <div class="text-center mt-5 mb-3">
        <h6 class="text-muted mb-3"><i class="bi bi-share me-1"></i>Share Results</h6>
        <button class="btn btn-success btn-lg me-2" onclick="shareWhatsApp()">
            <i class="bi bi-whatsapp me-2"></i>Share via WhatsApp
        </button>
        <button class="btn btn-outline-secondary btn-lg" id="copyBtn" onclick="copyResults()">
            <i class="bi bi-clipboard me-2"></i>Copy to Clipboard
        </button>
    </div>
    <hr class="my-3">

    <!-- Actions -->
    <div class="text-center">
        <a href="{{ url_for('export_pdf') }}" class="btn btn-danger btn-lg me-2">
            <i class="bi bi-file-earmark-pdf me-2"></i>Download PDF Report
        </a>
        <a href="{{ url_for('explain') }}" class="btn btn-warning btn-lg me-2">
            <i class="bi bi-lightbulb me-2"></i>View Explanation (XAI)
        </a>
        <a href="{{ url_for('compare') }}?{% for p in predictions %}crops={{ p.crop }}{% if not loop.last %}&{% endif %}{% endfor %}"
            class="btn btn-info btn-lg me-2">
            <i class="bi bi-bar-chart-line me-2"></i>Compare Crops
        </a>
        <a href="{{ url_for('predict') }}" class="btn btn-primary btn-lg me-2">
            <i class="bi bi-arrow-counterclockwise me-2"></i>Try Again
        </a>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-lg">
            <i class="bi bi-house me-2"></i>Home
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Pass data as JSON -->
<script type="application/json" id="chartData">
{{ predictions | tojson | safe }}
</script>
<script type="application/json" id="inputData">
{{ inputs | tojson | safe }}
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        try {
            var predictions = JSON.parse(document.getElementById('chartData').textContent);

            // Color based on score
            function getGaugeColor(value) {
                if (value >= 70) return { main: '#28a745', bg: 'rgba(40, 167, 69, 0.2)' };
                if (value >= 40) return { main: '#ffc107', bg: 'rgba(255, 193, 7, 0.2)' };
                return { main: '#dc3545', bg: 'rgba(220, 53, 69, 0.2)' };
            }

            // Create Speedometer Gauge (Main)
            function createSpeedometerGauge(canvasId, value, size) {
                var canvas = document.getElementById(canvasId);
                if (!canvas) return;

                var colors = getGaugeColor(value);

                new Chart(canvas.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [value, 100 - value],
                            backgroundColor: [colors.main, colors.bg],
                            borderWidth: 0,
                            circumference: 180,
                            rotation: 270
                        }]
                    },
                    options: {
                        responsive: false,
                        maintainAspectRatio: false,
                        cutout: size === 'large' ? '75%' : '70%',
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        }
                    },
                    plugins: [{
                        id: 'gaugeNeedle',
                        afterDraw: function (chart) {
                            var ctx = chart.ctx;
                            var centerX = chart.width / 2;
                            var centerY = chart.height - 10;
                            var radius = Math.min(chart.width, chart.height) * 0.35;

                            // Draw tick marks
                            if (size === 'large') {
                                ctx.save();
                                for (var i = 0; i <= 10; i++) {
                                    var angle = Math.PI + (Math.PI * i / 10);
                                    var x1 = centerX + Math.cos(angle) * (radius + 5);
                                    var y1 = centerY + Math.sin(angle) * (radius + 5);
                                    var x2 = centerX + Math.cos(angle) * (radius + 12);
                                    var y2 = centerY + Math.sin(angle) * (radius + 12);

                                    ctx.beginPath();
                                    ctx.moveTo(x1, y1);
                                    ctx.lineTo(x2, y2);
                                    ctx.strokeStyle = '#ccc';
                                    ctx.lineWidth = i % 5 === 0 ? 2 : 1;
                                    ctx.stroke();
                                }
                                ctx.restore();
                            }

                            // Draw needle
                            var needleAngle = Math.PI + (Math.PI * value / 100);
                            var needleLength = radius * 0.8;

                            ctx.save();
                            ctx.translate(centerX, centerY);
                            ctx.rotate(needleAngle);

                            // Needle body
                            ctx.beginPath();
                            ctx.moveTo(0, 0);
                            ctx.lineTo(needleLength, 0);
                            ctx.strokeStyle = '#333';
                            ctx.lineWidth = size === 'large' ? 3 : 2;
                            ctx.stroke();

                            // Needle center circle
                            ctx.beginPath();
                            ctx.arc(0, 0, size === 'large' ? 8 : 4, 0, Math.PI * 2);
                            ctx.fillStyle = '#333';
                            ctx.fill();

                            ctx.restore();
                        }
                    }]
                });
            }

            // Create main suitability gauge
            var topScore = Math.round(predictions[0].probability * 100);
            createSpeedometerGauge('suitabilityGauge', topScore, 'large');

            // Create mini gauges for alternatives
            predictions.slice(1).forEach(function (pred, index) {
                var score = Math.round(pred.probability * 100);
                createSpeedometerGauge('miniGauge' + (index + 1), score, 'small');
            });

            // Bar Chart (existing)
            var chartLabels = predictions.map(function (p) { return p.crop; });
            var chartData = predictions.map(function (p) { return Math.round(p.probability * 1000) / 10; });

            var barCanvas = document.getElementById('probabilityChart');
            if (barCanvas && typeof Chart !== 'undefined') {
                new Chart(barCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Confidence (%)',
                            data: chartData,
                            backgroundColor: ['rgba(40, 167, 69, 0.8)', 'rgba(40, 167, 69, 0.6)', 'rgba(40, 167, 69, 0.4)'],
                            borderColor: ['rgb(40, 167, 69)', 'rgb(40, 167, 69)', 'rgb(40, 167, 69)'],
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: { callback: function (v) { return v + '%'; } }
                            }
                        }
                    }
                });
            }

            console.log('✅ All charts created!');
        } catch (error) {
            console.error('Chart error:', error);
        }
    });

    // --- Share & Copy Functions ---
    function buildShareText() {
        var predictions = JSON.parse(document.getElementById('chartData').textContent);
        var inputs = JSON.parse(document.getElementById('inputData').textContent);
        var top = predictions[0];
        var prob = Math.round(top.probability * 100);

        var lines = [
            'CropAI Recommendation',
            '---------------------',
            'Best Crop: ' + top.crop,
            'Confidence: ' + prob + '%',
            'ROI: ' + Math.round(top.economic.roi) + '%',
            'Profit: Rs.' + Math.round(top.economic.profit) + '/acre',
            'Risk: ' + top.economic.risk_category,
            '',
            'Soil: N=' + inputs.N + ', P=' + inputs.P + ', K=' + inputs.K,
            'Weather: ' + inputs.temperature + 'C, ' + inputs.humidity + '% humidity',
            'pH: ' + inputs.ph + ', Rainfall: ' + inputs.rainfall + 'mm',
            'Season: ' + inputs.season,
            '',
            'Powered by CropAI'
        ];
        return lines.join('\n');
    }

    function shareWhatsApp() {
        var text = buildShareText();
        window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank');
    }

    function copyResults() {
        var text = buildShareText();
        var btn = document.getElementById('copyBtn');
        var originalHTML = btn.innerHTML;

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function () {
                btn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Copied!';
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-success');
                setTimeout(function () {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 2000);
            });
        } else {
            // Fallback for older browsers
            var ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            btn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Copied!';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-success');
            setTimeout(function () {
                btn.innerHTML = originalHTML;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        }
    }
</script>
{% endblock %}