{% extends "base.html" %}

{% block title %}Model Dashboard | CropAI{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="text-center mb-5">
        <h2 class="fw-bold">
            <i class="bi bi-cpu text-primary me-2"></i>Model Performance Dashboard
        </h2>
        <p class="text-muted">Compare all trained ML models and their accuracy metrics</p>
    </div>

    <!-- Active Model Banner -->
    <div class="alert alert-success d-flex align-items-center mb-5">
        <i class="bi bi-check-circle-fill fs-4 me-3"></i>
        <div>
            <strong>Currently Active:</strong> Stacking Ensemble (Random Forest + XGBoost + LightGBM)
            <br><small class="text-muted">This is the model being used for predictions</small>
        </div>
    </div>

    <!-- Model Accuracy Cards -->
    <div class="row g-4 mb-5">
        {% for model in models %}
        <div class="col-md-3">
            <div class="card h-100 {% if model.name == 'Stacking Ensemble' %}border-success border-3{% endif %}">
                {% if model.name == 'Stacking Ensemble' %}
                <div class="card-header bg-success text-white text-center py-2">
                    <i class="bi bi-trophy-fill me-1"></i> Best Model
                </div>
                {% endif %}
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="bi {{ model.icon }} fs-1 text-{{ model.color }}"></i>
                    </div>
                    <h5 class="fw-bold">{{ model.name }}</h5>

                    <!-- Accuracy Gauge -->
                    <div class="position-relative d-inline-block my-3" style="width: 120px; height: 70px;">
                        <canvas id="gauge{{ loop.index }}" width="120" height="70"></canvas>
                        <div class="position-absolute" style="bottom: 5px; left: 50%; transform: translateX(-50%);">
                            <h4 class="mb-0 text-{{ model.color }} fw-bold">{{ model.accuracy }}</h4>
                        </div>
                    </div>

                    <small class="text-muted d-block">Accuracy</small>

                    <div class="mt-3 small">
                        <div class="d-flex justify-content-between">
                            <span>Precision:</span>
                            <strong>{{ model.precision }}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>F1-Score:</span>
                            <strong>{{ model.f1 }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Comparison Chart -->
    <div class="row mb-5">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-body">
                    <h5 class="fw-bold mb-4">
                        <i class="bi bi-bar-chart-fill me-2"></i>Model Accuracy Comparison
                    </h5>
                    <canvas id="comparisonChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Details Table -->
    <div class="card mb-5">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="bi bi-table me-2"></i>Detailed Metrics
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Model</th>
                            <th class="text-center">Accuracy</th>
                            <th class="text-center">Precision</th>
                            <th class="text-center">Recall</th>
                            <th class="text-center">F1-Score</th>
                            <th class="text-center">Training Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for model in models %}
                        <tr class="{% if model.name == 'Stacking Ensemble' %}table-success{% endif %}">
                            <td>
                                <i class="bi {{ model.icon }} text-{{ model.color }} me-2"></i>
                                <strong>{{ model.name }}</strong>
                                {% if model.name == 'Stacking Ensemble' %}
                                <span class="badge bg-success ms-2">Active</span>
                                {% endif %}
                            </td>
                            <td class="text-center fw-bold text-success">{{ model.accuracy }}</td>
                            <td class="text-center">{{ model.precision }}</td>
                            <td class="text-center">{{ model.recall }}</td>
                            <td class="text-center">{{ model.f1 }}</td>
                            <td class="text-center">{{ model.train_time }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ensemble Explanation -->
    <div class="card bg-light border-0 mb-5">
        <div class="card-body">
            <h5 class="fw-bold mb-3">
                <i class="bi bi-info-circle text-primary me-2"></i>Why Stacking Ensemble?
            </h5>
            <p class="mb-2">The Stacking Ensemble combines the strengths of multiple models:</p>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-tree-fill text-success fs-4 me-3"></i>
                        <div>
                            <strong>Random Forest</strong>
                            <small class="d-block text-muted">Robust to overfitting</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-lightning-fill text-warning fs-4 me-3"></i>
                        <div>
                            <strong>XGBoost</strong>
                            <small class="d-block text-muted">High performance</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-speedometer2 text-info fs-4 me-3"></i>
                        <div>
                            <strong>LightGBM</strong>
                            <small class="d-block text-muted">Fast training</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feature Engineering Section -->
    {% if features %}
    <div class="card border-primary mb-5">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-magic me-2"></i>Feature Engineering Pipeline
            </h5>
        </div>
        <div class="card-body">
            <!-- Feature Count Summary -->
            <div class="row text-center mb-4">
                <div class="col-md-4">
                    <div class="p-3 bg-light rounded">
                        <h2 class="text-primary mb-0">{{ features.raw_features | length }}</h2>
                        <small class="text-muted">Raw Inputs</small>
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-center justify-content-center">
                    <i class="bi bi-arrow-right-circle text-primary fs-1"></i>
                </div>
                <div class="col-md-4">
                    <div class="p-3 bg-success bg-opacity-10 rounded">
                        <h2 class="text-success mb-0">{{ features.feature_count }}</h2>
                        <small class="text-muted">Engineered Features</small>
                    </div>
                </div>
            </div>

            <!-- Raw Features -->
            <h6 class="fw-bold mb-3"><i class="bi bi-input-cursor me-2"></i>Raw Input Features (7)</h6>
            <div class="d-flex flex-wrap gap-2 mb-4">
                {% for feat in features.raw_features %}
                <span class="badge bg-primary px-3 py-2">
                    {% if feat == 'N' %}<i class="bi bi-radioactive me-1"></i>
                    {% elif feat == 'P' %}<i class="bi bi-flower2 me-1"></i>
                    {% elif feat == 'K' %}<i class="bi bi-gem me-1"></i>
                    {% elif feat == 'temperature' %}<i class="bi bi-thermometer-sun me-1"></i>
                    {% elif feat == 'humidity' %}<i class="bi bi-droplet-half me-1"></i>
                    {% elif feat == 'ph' %}<i class="bi bi-moisture me-1"></i>
                    {% elif feat == 'rainfall' %}<i class="bi bi-cloud-rain me-1"></i>
                    {% endif %}
                    {{ feat }}
                </span>
                {% endfor %}
            </div>

            <!-- Engineered Features by Category -->
            <h6 class="fw-bold mb-3"><i class="bi bi-stars me-2"></i>Engineered Features ({{ features.feature_count }})
            </h6>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="border rounded p-3 h-100">
                        <h6 class="text-success"><i class="bi bi-calculator me-2"></i>Nutrient Ratios</h6>
                        <small class="text-muted">N_to_P_ratio, N_to_K_ratio, P_to_K_ratio, NPK_sum, NPK_product</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="border rounded p-3 h-100">
                        <h6 class="text-info"><i class="bi bi-thermometer me-2"></i>Climate Indices</h6>
                        <small class="text-muted">climate_index, heat_stress_index, temp_humidity_interaction</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="border rounded p-3 h-100">
                        <h6 class="text-primary"><i class="bi bi-water me-2"></i>Water Metrics</h6>
                        <small class="text-muted">water_stress_index, moisture_index, rainfall_per_temp</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="border rounded p-3 h-100">
                        <h6 class="text-warning"><i class="bi bi-pie-chart me-2"></i>Dominance</h6>
                        <small class="text-muted">N_dominance, P_dominance, K_dominance</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="border rounded p-3 h-100">
                        <h6 class="text-secondary"><i class="bi bi-grid me-2"></i>Interactions</h6>
                        <small class="text-muted">N_ph_interaction, P_ph_interaction, K_ph_interaction</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="border rounded p-3 h-100">
                        <h6 class="text-danger"><i class="bi bi-tag me-2"></i>Categories</h6>
                        <small class="text-muted">temp_category, humidity_category, ph_category,
                            rainfall_category</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Button -->
    <div class="text-center mt-5">
        <a href="{{ url_for('predict') }}" class="btn btn-primary btn-lg">
            <i class="bi bi-search me-2"></i>Try Prediction
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="application/json" id="modelData">
{{ models | tojson | safe }}
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var models = JSON.parse(document.getElementById('modelData').textContent);

        // Create mini gauges
        models.forEach(function (model, index) {
            var canvas = document.getElementById('gauge' + (index + 1));
            if (!canvas) return;

            var acc = parseFloat(model.accuracy);
            var color = acc >= 98 ? '#28a745' : acc >= 95 ? '#ffc107' : '#dc3545';

            new Chart(canvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [acc, 100 - acc],
                        backgroundColor: [color, 'rgba(200,200,200,0.2)'],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: false,
                    cutout: '70%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
        });

        // Comparison bar chart
        var accuracies = models.map(function (m) { return parseFloat(m.accuracy); });
        var minAcc = Math.min.apply(null, accuracies);
        var yMin = Math.max(0, Math.floor(minAcc / 5) * 5 - 5);

        new Chart(document.getElementById('comparisonChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: models.map(function (m) { return m.name; }),
                datasets: [{
                    label: 'Accuracy (%)',
                    data: accuracies,
                    backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14', '#20c997', '#0d6efd'],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: false, min: yMin, max: 100, ticks: { callback: function (v) { return v + '%'; } } }
                }
            }
        });
    });
</script>
{% endblock %}